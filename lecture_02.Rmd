Lecture 02/03/04 -- Sept 05/10/12 2013
===============================================================================

Model the data

```{r, warn=FALSE, message=FALSE}
library(lmSupport)
library(ggplot2)
library(lavaan)
install.packages("OpenMx")
library(OpenMx)
d <- lm.readDat("data/data_apgar.dat")
describe(d)
# Predict APGAR from weight gain
m1 <- lm(apgar ~ wgtgain, d)
summary(m1)
qplot(data = d, x = wgtgain, y = apgar)
```

Standardize the weight gain and APGAR scores, so they are both expressed in standard deviation units. Observe that standardization did not change the _p_-values.

```{r fig.width=7, fig.height=6}
d <-  transform(d, zwgtgain = scale(wgtgain), zapgar = scale(apgar), zsmokes = scale(smokes))
describe(d)
m2 <- lm(zapgar ~ zwgtgain, d)
summary(m2)
```


Regress APGAR on smoking. Standardized categorical variables are hard to interpret.

```{r}
m3 <- lm(apgar ~ smokes, d)
summary(m3)
qplot(data = d, x = smokes, y = apgar) + geom_smooth(method="lm")
# Standardized variables
m4 <- lm(zapgar ~ zsmokes, d)
summary(m4)
qplot(data = d, x = zsmokes, y = zapgar) + geom_smooth(method="lm")
```

Regress APGAR on weight-gain and smoking. The coefficient of weight-gain is predicted change in APGAR for a unit change in weight-gain, when statistically controlling for smoking. The coefficient for smoking is expected change in APGAR if the mother smokes, over and above the effect of weight-gain. Note that the individual predictors for smoking and weight-gain become more significant. By controlling for one variable, the other variable can explain a larger proportion of the variance in the dependent variable. The standardized effects allow us to coarsely compare the effects to each other.

We allow exogenous variables to be correlated, in an unanalyzed relationship. Exogenous variables do not have a cause specified in the modelling. Weight gain and smoking would be exogenous variables in these variables. Double arrow is an unanalyzed relationship. Two single arrows form a mutual influence relationship.

```{r}
m5 <- lm(apgar ~ wgtgain + smokes, d)
summary(m5)
# Standardized variables
m6 <- lm(zapgar ~ zwgtgain + zsmokes, d)
summary(m6)
```

Covariance is the correlation of the variable times the standard deviation of each variable. Covariance takes into account the unit of measurement of the variables. 
cov = r * SD1 * SD2


Covariance matrix has 10 pieces of information. Correlation matrix has 6 pieces of information.
```{r}
# Observed correlation matrix
d <- subset(d, select=c(apgar, gestat, smokes, wgtgain))
round(cor(subset(d, select=c(apgar, gestat, smokes, wgtgain))), 2)
```



// We randomly assign path coefficients. Then we compute correlations.

Why would variables be correlated?

1. A causes B
2. Mediation: A causes B causes C
3. Unanalyzed effects: C causes A,B; C correlates with D, C causes A, D causes B causes E

Assumed causal paths:

S <--a--> W
S  --b--> G
S  --c--> A
W  --d--> G
W  --e--> A
G  --f--> A

Correlation values based on the causal paths:

cor_sw = a
cor_sg = b + a*d
cor_wa = e + d*f + a*c + a*b*f
cor_sa = c + b*f + a*e + a*d*f
cor_wg = d + a*b
cor_ga = f + a*b*f + a*c*d + b*c + d*e

Maximum-likelihood tries to find the best values for a:f to generate the model-implied correlation matrix



```{r}

m1 <- '
      # regressions
      gestat ~ smokes + wgtgain
      apgar ~ smokes + wgtgain + gestat
      # residual correlations
      smokes ~~ wgtgain
      '

fit <- sem(m1, data=d, likelihood="wishart")
summary(fit, standardized=T)
inspect(fit, "sampstat")
fitted(fit)
# difference between the two covariance matrices
resid(fit) 
```
The model perfectly replicated the observed covariance matrix.

Minimum function test statistic is a chi-squared test statistic.

If the p-value is significant, we reject the model.
If the p-value is not significant, we can accept the model.

"Disturbances" are residuals of the model. They are latent variables. They contain all the other causes that were not specified in the model. Usually only have distrubances for the endogenous variables. Disturbances have the same unit of measurement as their associated variable.

The variances in the inspecti.fit give the variances in of the disturbances for the endogenous variables.


```{r}
# Variances of the disturbances for gestat: 20.003
var(d$gestat) # 29.02

# Explaining 31% of the variance
1 - (20.003 / 29.02)


apgar_variance <- fitted(fit)$cov["apgar", "apgar"]
# Disturbances in APGAR: 
apgar_distrurbances <- 1.912

R_squared <- 1 - (apgar_distrurbances / apgar_variance)
R_squared


```

### Standardized solution

Don't need to report variances in the standardized solution.

Need to footnote that you ran the model on non-standardized variables and got the values for the standardized solution for that.


## 

```{r}
m1b <- '
  # regressions
  gestat ~ smokes + wgtgain
  apgar ~ smokes + wgtgain + gestat
'
fit <- sem(m1b, data=d, likelihood="wishart")
summary(fit, standardized=T)
```

Output does not include unanalyzed relationships. 

Wishart variance divides by n-1. Normal or biased variance divides by n. i

## Weird model
4 exogenous variables, 0 endogenous variables, allowing exogenous vars to correlate. We are going to estimate the four variances.

```{r}
m1b <- '
  # residual correlations
  smokes ~~ wgtgain
  smokes ~~ gestat
  smokes ~~ apgar
  wgtgain ~~ gestat
  wgtgain ~~ apgar
  gestat ~~ apgar
  '
fit2 <- sem(m1b, d, likelihood="wishart")
summary(fit2, standardized=T)
```

The weird model has 1 for all the disturbances in the standardized solution. Chi-squared = 0. 